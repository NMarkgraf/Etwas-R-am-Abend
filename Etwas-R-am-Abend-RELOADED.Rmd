---
title: "Etwas R am Abend"
author: "Norman Markgraf"
date: "06.12.2017"
institute: Standort Köln
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
    echo = TRUE,
    background='#E0E0E0',
#   fig.keep="none",
    out.width="80%",
#   cache = TRUE,
#    tidy=TRUE,
    fig.align = "center",
    width.cutoff=60
)
options(width = 73)
library(mosaic)
library(tidyverse)
library(formatR)
library(mosaic)

set.seed(2009)
```

```{r child = './content/010-Einfuehrung-R.Rmd'}
```

```{r child = './content/020-Installation-R.Rmd'}
```

```{r child = './content/030-Erste-Schritte-in-R.Rmd'}
```

```{r child = './content/035-Strukturen-in-R.Rmd'}
```

```{r child = './content/037-Statistische-Funktionen.Rmd'}
```

```{r child = './content/040-Ein-paar-Schritte-in-R.Rmd'}
```

```{r child = './content/060-Eine-kurze-Datenanalyse.Rmd'}
```

```{r child = './content/070-R-intern.Rmd'}
```

```{r include=FALSE, eval=FALSE}
# Appendix
```

```{r child = './content/A010-Literatur.Rmd'}
```

```{r child = './content/A070-Videos.Rmd'}
```

```{r child = './content/A090-Copyright.Rmd'}
```



## Eine kurze Datenanalyse

Im Folgenden kann man ein paar der Möglichkeiten von **R** finden, wie man sie in Vorlesungen braucht.

Dazu nehmen wir die Daten *tips* aus dem Unterrichtsmaterialsammlung von **Prof. Dr. Sebastian Sauer**.

https://github.com/sebastiansauer/Daten_Unterricht 

```{r, echo=TRUE, warning=FALSE, error=FALSE, message=FALSE}
library(readr)
path <- paste0("https://raw.githubusercontent.com/sebastiansauer/",
               "Daten_Unterricht/master/tips.csv")
tips <- read_csv(file=path)
tips$X1 <- NULL
```

Darüberhinaus nutzen wir einige Befehle aus der Paketsammlung **Mosaic**, welches wir dazu laden
```{r}
library(mosaic) # Hauptsächlich "lattice"
```

## Daten ansehen

Schauen wir uns die Daten etwas an:

```{r, tidy=TRUE, size='tiny', tidy.opts=list(blank=FALSE, width.cutoff=60)}
glimpse(tips)
```

Dimension des Datensatzes:
```{r}
dim(tips)
```



## Balkendiagramm bei kategorialen Daten
:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
bargraph(~sex, data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(sex, data=tips)
```

:::
::::::::::::::

## Histogramm bei metrischen Daten

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
histogram(~tip, data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(tip, data=tips, binwidth=1)
```

:::
::::::::::::::

## Histogramm bei metrischen Daten, facettiert

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
#
histogram(~tip | sex, data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(tip, facets = ~sex, data=tips, 
      binwidth=1, geom="histogram")
```

:::
::::::::::::::

## Boxplots bei metrischen Daten

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
#
bwplot(~tip, data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(x=1, y=tip, data=tips, 
      geom="boxplot")
```

:::
::::::::::::::


## Boxplot mit metrischen Daten für Gruppem

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
#
bwplot(tip ~ sex, data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(x=sex, y=tip, data=tips, 
     geom="boxplot")
```

:::
::::::::::::::

## Boxplot mit metrischen Daten für Gruppen, facettiert 

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
#
bwplot(tip ~ sex | smoker, 
       data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(x=sex, y=tip, data=tips, 
      facets=~smoker,
      geom="boxplot")
```

:::
::::::::::::::

## Streudiagramm mit zwei metrischen Variablen

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(lattice)
xyplot(tip~total_bill, 
       data=tips)
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
library(ggplot2)
qplot(total_bill, tip,
      data=tips)
```

:::
::::::::::::::


## Häufigkeitstabellen zwei kategorialen Variablen

Dazu generieren wir die Häufigkeitstabelle mit dem Befehl *tally* und speichern sie in *tab*

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, tidy=TRUE,}
library(mosaic)
tab <-tally(sex ~ smoker, data=tips)
tab
```

:::
::: {.column width="49%"}

```{r eval=FALSE}
library(knitr)
kable(tab, 
  col.names=c("N.-Raucher", "Raucher"))
```
```{r echo=FALSE}
if (knitr:::is_latex_output()) {
kable(tab, format="latex",
      col.names=c("N.-Raucher", "Raucher")
      )
} else {
    kable(tab, 
      col.names=c("N.-Raucher", "Raucher"))
}
```

:::
::::::::::::::

Eine Variante mit relativen Häufigkeiten erhält man mit:

:::::::::::::: {.columns} 
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
tally(sex ~ smoker, data=tips,
      format="proportion")
```

:::
::: {.column width="49%"}

```{r, eval=TRUE, echo=TRUE}
tally(sex ~ smoker, data=tips,
      format="percent")
```

:::
::::::::::::::



## mosaicplot mit zwei kategorialen Variablen


Mit der Tabelle *tab*  kann nun ein mosaic plot generiert werden:

```{r, tidy=TRUE}
mosaicplot(tab)
```

## Korrelationsplot mit metrischen Variablen

```{r, tidy=TRUE}
# ggf:  install.packages("corrgram", dependencies=T)
library(corrgram)
corrgram(tips)
```

## Kennzahlen

Mittelwert
```{r, tidy=TRUE}
mean(tip~sex, data=tips)
```

Anstatt *mean* können alle Lageparameter und Streumaße errechnet werden (min, max, median, sd, var):
```{r, tidy=TRUE,}
favstats(tip~sex, data=tips)
```

Korrelation als Zusammenhangsmaß mit metrischen Variablen
```{r, tidy=TRUE,}
cor(tip~total_bill, data=tips)
```

## $\chi^2$-Test
Test der Unabhängigkeit geht nur mit zwei nominalen Variablen. In *tab* haben wir solche schon generiert.

`r if (knitr:::is_latex_output()) '\n\\smallverb'`
```{r, tidy=TRUE,}
xchisq.test(tab)
```

## t-Test für abhängige Stichproben (Differenzentest)

Variablen müssen beide metrische sein und zwischen beiden Variablen wird eine Differenz gebildet.

Die Forschungsfrage lautet meist:

 - V1 unterscheidet sich von V2 (ungerichtet)
 - V1>V2 (gerichtet)
 - V2>V1 (gerichtet)

```{r, tidy=TRUE,}
t.test(~(tip-total_bill), data=tips)
```
## t-Test für abhängige Stichproben (Differenzentest) 

Wenn die Forschungshypothese (Alternativhypothese) gerichtet ist, und
V1-V2 < 0 ist, dann wird das Argument alternative="less" hinzugefügt,
wenn V1-V2 > 0, dann "greater".

```{r, tidy=TRUE,}
t.test(~(tip-total_bill), alternative="less", data=tips)
```

**Achtung:**
Bei der Dokumentation von t-Tests ist es wichtig, einseitiges Testen von zweiseitigem Testen zu unterscheiden (einseitig/zweiseitig).


## ANOVA (Varianzanalyse)

Bezüglich einer Gruppe (nominale Variable) mit mehr als zwei Levels wird eine metrische Variable getestet.

```{r, tidy=TRUE,}
bwplot(tip~day, data=tips)
```


## ANOVA (Varianzanalyse)

```{r, tidy=TRUE,}
favstats(tip~day, data=tips)
```

*Forschungshypothese:* Es gibt einen Unterschied beim Trinkgeld bei/zwischen den Tagen.

```{r, tidy=TRUE,}
summary(aov(tip~day, data=tips))
```


## Lineare Einfachregression mit metrischer Variable.

Modellierung einer angängigen Variable (AV) durch eine unabhängige Variable (UV).
`r if (knitr:::is_latex_output()) '\n\\smallverb'`
```{r, tidy=TRUE,}
Mod1<-lm(tip~total_bill, data=tips)
summary(Mod1)
```

## Lineare Einfachregression mit kategorialer UV

**Achtung:** Das nicht ausgegebene Level in der Ausgabe ist das Referenzlevel.
`r if (knitr:::is_latex_output()) '\n\\smallverb'`
```{r, tidy=TRUE, size="small", highlight=TRUE}
Mod2<-lm(tip~day, data=tips)
summary(Mod2)
```

## Multiple Regression
```{r, tidy=TRUE, size='tiny', tidy.opts=list(blank=FALSE, width.cutoff=75), eval=FALSE}
Mod3<-lm(tip~total_bill + sex + smoker + day + time + size, data=tips)
summary(Mod3)
```
```{r, echo=FALSE, tidy=TRUE, size='tiny', tidy.opts=list(blank=FALSE, width.cutoff=55), }
Mod3<-lm(tip~total_bill + sex + smoker + day + time + 
         size, data=tips)
txt <- capture.output(summary(Mod3))
splitat <- 25
library(stringi)
```

:::::::::::::: {.columns} 
::: {.column width="49%"}

\scriptsize\ttfamily
\begin{verbatim}
`r paste0(stri_wrap(txt[1:splitat], width=55, normalize=FALSE), collapse="\n## ")`
\end{verbatim}

:::
::: {.column width="49%"}

\scriptsize\ttfamily
\begin{verbatim}
`r paste0(stri_wrap(c("",txt[-(1:splitat)]), width=55, normalize=FALSE), collapse="\n## ")`
\end{verbatim}
\normalsize

:::
::::::::::::::

## Der Befehl *step*

Mit dem Befehl *step* führt man eine stufenweise Regressionsanalyse durch,
bei der die Variablen nach der Reihenfolge ihrer Wichtigkeit entfernt werden.

```{r, eval=FALSE}
step(Mod3)
```
```{r, echo=FALSE}
txt <- capture.output(step(Mod3))
splitat <- 29
```

:::::::::::::: {.columns} 
::: {.column width="49%"}

\scriptsize\ttfamily
\begin{verbatim}
`r paste0(stri_wrap(c("",txt[1:splitat]), width=55, normalize=FALSE), collapse="\n## ")`
\end{verbatim}

:::
::: {.column width="49%"}

\scriptsize\ttfamily
\begin{verbatim}
`r paste0(stri_wrap(c("",txt[-(1:splitat)]), width=55, normalize=FALSE), collapse="\n## ")`
\end{verbatim}
\normalsize

:::
::::::::::::::

## Wie geht es weiter?

Dieses kleine Kick-Off für **R** ist natürlich nicht vollständig. - Wo es, aus meiner persönlichen Sicht, lohnt weiter zu schauen sind die folgenden Themen:

* **Grammar of Graphic** und **ggplot2** für schönere und aussagekräftige Grafiken in **R**.
* *tidyr*, [dplyr](https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html)  und Co, die Welt des Datenmanagement in **R**
* [*rmarkdown*](http://rmarkdown.rstudio.com) und der Weg zu eigenen Dokumenten 
* [*Shiny*](http://shiny.rstudio.com) und die interaktive Webdarstellung von Statistiken 
* *mosaic* 

